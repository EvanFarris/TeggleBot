# TeggleBot
## Purpose
Create a Discord Bot that notifies text channels when a Twitch.tv streamer goes live.
## Perks over competitors
- Setup is completely in Discord, no web interface. 
- Every field can be changed (Change which channel gets notified, message that gets sent with the embed, image that is sent in the embed)
- Stream Status is shown and updated when streamer goes online or offline
- Link to the VOD is added, if VODs are enabled.
- Free, built only for notifying streams.
## Try out the bot
If you don't want to host your own bot, or want to try mine out, invite my bot below, read command information.
### Invitation link
[Click this invitation link](https://discord.com/oauth2/authorize?client_id=963284271655702568&scope=bot&permissions=134144)
### Quick-start 
After inviting the bot to the server, use /follow to get notifications. [Example Command](https://i.imgur.com/HB67Xlw.png)

Fields
- url(Required): The url of the streamer you want to follow (ex: https://twitch.tv/teggledev)
- disc_channel(Required): The Discord channel you want to send stream notifications to. 
- message: The message to be sent with the notification, you can mention roles, @everyone, etc. 
- image: A url that directly links to an image to show with the notification. 

The Bot will reply with [a message that looks like this](https://i.imgur.com/90UZvwe.png), you will have 15 seconds to confirm that this is the correct streamer (click the blue header to open the channel), before it expires, and you will have to re-enter the command.

After pressing the follow button, the bot will send [this message](https://i.imgur.com/mStE35v.png)

And you should be all set, five Twitch streamers can be followed per server. [Example notification](https://i.imgur.com/SqKKciE.png)

__Note: The bot must be in the channel and be able to send messages, otherwise no message will be sent.__
### Other commands
- /unfollow			#Reverse of /follow, stops notifications from happening
- /following			#Show every channel you follow
- /change_channel		#Change the channel that a specific streamer's notifications are sent to
- /change_image			#Change the image that gets shown with the notification
- /change_message		#Change the message that gets sent with the notification
- /stats			#Shows stats about the bot
- /check_id			#Shows Guild id and channel id

## Why this bot was made
The short answer is that the community server for my favorite streamer was using the massively popular Mee6 bot, and livestream notifications would take anywhere from 2-40 minutes to be sent([Mee6](https://i.imgur.com/Af4dVaE.png) vs [TeggleBot](https://i.imgur.com/B4bsUpQ.png), so I wanted to see if I could do better. 

The long answer, in addition to the previous statement, is that Discord notifications in my opinion is superior than Twitch notifications. 
```
I believe there is a different connotation with a notification coming from Discord and one coming from Twitch. Just like how the content difference between an email and a text exists, despite both being instant, text-based, messaging systems. Since Discord is a social platform, notifications are usually welcomed, as they either involve you, or are relevant to your interests. Twitch's system of follow notifications is all or nothing. So you can't limit the number of notifications you get, without unfollowing the streamers.
```
Why didn't I just search for another person's bot to use? 
- I wanted to learn how to make a Discord bot.
- I felt that other implementations of stream notifications were barebones.
- I didn't want all the extra features that I would never use or would have to pay for.

## Requirements to host this bot
This project is run on Ubuntu 22.04, with Node.js.

There are six major components needed for this program to work
1. Buy (or use) a domain and create an A record pointed to the IP of the machine that hosts the program.
2. A SSL certificate, a free one can be generated by [Let's Encypt](https://letsencrypt.org)
3. Configure the host machine to use a reverse proxy (ex. Nginx), an explanation is further down the file.
4. Must create a Discord account and [create a new application](https://discord.com/developers/applications)
5. Must create a Twitch.tv account and [create an application](https://dev.twitch.tv/console/apps)
5. A .env file

A domain is needed in cases where APIs require a redirect url to return the data requested from an API call. An individual IP address is normally not sufficient. Purchase one from a domain broker such as GoDaddy, Namecheap, Google Domains, etc.

The SSL certificate is necessary, Twitch's API requires a redirect url to be ssl certified to return data. __It can not be a self-signed ssl certificate__, but you can get one for free from Let's Encrypt (link above). 

The reverse proxy in this use case connects the request to the application, redirecting the request to the port number the program is listening to on localhost.

Since we need to use Discord's API to add the playlist to a user's account, we need to register an account and create an application. This allows us to interact with the API, through the use of the application id and secret.

We also need an account for Twitch as well,

To avoid uploading sensitive information like the application id/secret, we store the data in a .env file, and it is not uploaded to git. In this project, it is structured like the code below; however, without the comments.
```
DISCORD_BOT_TOKEN=			#index.js | deploy_commands.js |Token generated when you add a bot to your Discord application (Bot tab)
DISCORD_CLIENT_ID=			#deploy_commands.js | Application ID of your bot (General Information tab) 
DISCORD_TEST_SERVER_ID=		#deploy_commands.js | Guild (Programmatic name for a discord server) Id for a personal test Guild 
DISCORD_TEST_SERVER_ID2=	#deploy_commands.js | Same as above, but for a second test server
TWITCH_CLIENT_ID=			#index.js | Client ID from Twitch
TWITCH_CLIENT_SECRET=		#index.js | Client Secret from Twitch
TWITCH_ACCESS_TOKEN=		#index.js | String that you randomly generate
HOST_NAME=					#index.js | Your domain name, in the example "https://teggle.dev/spotify", "HOST_NAME=teggle.dev" 
ADAPTER_PORT=				#index.js | Port you want to watch for notifications, same port as you put in nginx
PATH_PREFIX=				#index.js | The location you set when setting up nginx.  "PATH_PREFIX=/spotify" in the example at the bottom of the file
SEQUELIZE_USER=				#index.js | Login for the database
SEQUELIZE_PASS=				
DB_NAME=					#index.js | Information about the database, can be local or remote
DB_HOST=
DB_DIALECT=
DB_STORAGE=
```

## Usage
### Inviting the bot to a Guild
If you are using the bot with test guilds, invite the bot with https://discord.com/oauth2/authorize?client_id=CLIENT_ID_HERE&scope=bot&permissions=134144 
Where __CLIENT_ID_HERE__ is the same as the DISCORD_CLIENT_ID in your .env file. The only permissions this bot currently needs is View Channels, Send Messages, and Mention @everyone, @here, etc.
### Starting the bot
To start the bot, you can run either of the two lines below, the first launches the program in the foreground, the latter in the background.
```
npm start
(npm start &)
```
You can also use the --force option below to empty all the databases when starting the bot.
> npm start --force

## The Bot, explained
### Index.js
All of the setup is in index.js
1. npm start is called.
2. deploy-commands.js registers the slash commands with Discord.
3. After deploy-commands.js finishes, index.js is now started.
4. Packages, helper files, and environment variables(.env) are loaded in.
5. A discord client is instantiated, but is not connected yet to Discord's servers.
6. Discord slash commands and events are loaded into the client object
7. The databases and hashmaps used are setup
8. Twitch's Client object is setup, connected to the reverse proxy adapter, but not listening for events.
9. If --force is set, wipe all the tables and remove all subscriptions.
10. Otherwise, reload twitch subscriptions into the hashmap, so the bot knows how to handle callbacks. 
11. Start the Discord listener
12. Start the Twitch listener
13. Wait for either Twitch callbacks or Discord events to occur.
14. If a callback from Twitch occurs, notify all channels following that streamer.
15. If it's a Discord event or interaction, handle it appropriately.

Most of the heavy lifting is in ./helperFiles/database_functions.js, embed/validation_functions are mainly for display purposes or checking if proper input was given.

### Events
Events in this program are something notable occurring most of the time by human interaction, but some may be caused by machines. An event gets emitted by Discord to the bot (and other users), they are listed [here](https://discord.js.org/#/docs/discord.js/main/typedef/Events), and the behavior to handle these events can be changed. In the events folder, we have four events that we handle: InteractionCreate, ChannelDelete, GuildDelete, and ready.js.

InteractionCreate is our main event, anything from using a slash command, to pressing a button, or interacting with a string select menu, triggers the InteractionCreate event. 

ChannelDelete is emitted whenever a channel gets deleted. Our use case is to cleanup our database when a channel gets deleted, if it is one that get sent notifications. Essentially, if notifications are sent to a channel that gets deleted, you unfollow the affected streamers, and will have to use /follow again.

GuildDelete is similar to ChannelDelete, but when the entire server gets deleted. First, it unfollows every streamer the guild does, then deletes the table in guild_subs.

ready.js is fired after Client.listen finishes and is ready to receive events.

### Slash Commands
All interactions with the bot are initially started with a slash command, the bot does not read any messages.
There are three folders with commands
- devCommands: This folder has commands that only work in the test guilds you set in .env, as they shouldn't be available to the public.
- safeCommands: The commands in here are the few commands that don't modify anything in the database, so they can be called by anybody, at any time.
- commands: Commands that alter entries in the database. These are callable only by people with at least one of these three permissions: Administrator, ManageGuild, or ManageWebhooks. In addition, only one command from this folder can be processed at a time, in order to prevent race conditions.

## Pitfalls and addressing those pitfalls
The Twitch.tv API is harder to work than Discord. The major reason is because it required a webserver to send API replies, as opposed to (presumably) websockets with Discord. In addition, Discord.js has a wonderful guide, on top of great documentation, opposed to the twitch library. However, it's not a major gripe, as both libraries are open-source and community made, and their work eliminates a ton of work that is otherwise needed.

It was impossible to consistently get the correct stream thumbnail. According to most posts on Twitch's dev forum, the problem is a caching problem. The eventsub notification is sent a lot faster than twitch's cdn caches updates. So a lot of the time, a default image is sent. I don't think this is the full story, however. Sometimes the image would be correctly displayed for a streamer for a few days, then upon a restart with no change, it wouldn't work. Also, I noticed that sometimes, between four different platforms(Windows 10, Windows 11, Android, and the web client), the image would work on some platforms but not on other platforms. I asked this question on the Discord.js server, and the response was that it was just something only Discord could solve. So with the caching problem from Twitch, and the display error from Discord, I opted to remove the stream thumbnail for the time being, replacing it with a user supplied image, if the image is hosted on some other website. 

## Learned
1. Explore how Discord bots work
2. Learn about event-driven programming
3. Learn how to interact programmatically with an API
4. Learn how to integrate two APIs
5. Learned about domains and reverse proxies
6. Learned more about JS and Node.js
7. Reinforced VM knowledge
8. Updating libraries and reading changelogs

## Future Work
1. Log all actions
2. Update Notifications when stream title/game updates
3. Support more streaming platforms
4. Revisit stream thumbnails not being consistent

## Nginx setup
1. Install nginx
2. Configure /etc/nginx/sites-available/default to listen on ssl, install the ssl certificate, and setup the reverse proxy
```
server {
	listen 443 ssl;
	listen [::]:443 ssl;
	server_name DOMAIN_NAME;
	ssl_certificate /etc/letsencrypt/live/certificate-folder/fullchai-/change_message	#Change the message that gets sent with the notification
n.pem;
	ssl_certificate /etc/letsencrypt/live/certificate-folder/privkey.pem;
	location /spotify {
		proxy_pass http://127.0.0.1:PORT_NUMBER/;
	}
}
```

Where PORT_NUMBER is the port you set in .env, and __DOMAIN_NAME__ is the host domain (ex: teggle.dev)

3. Restart Nginx
```
sudo systemctl restart nginx
```
If there is no error output, then everything is fine. Otherwise re-edit /etc/nginx/sites-available/default 

4. Add rules to your firewall to allow traffic 
```
sudo ufw allow `Nginx Full`
```

5. If using a VM on a physical computer on your home network, you may have to port forward any traffic on 443 to your vm's internal network ip (192.168.x.x)
